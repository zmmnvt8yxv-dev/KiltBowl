let scheduleByTeam = {}; // { TEAM: { opp: TEAM, homeAway: 'vs'|'@', gameStatus: string, start: string } }
let updateTimer = null;
let lastUpdatedTime = null;

// Weekly stats cache: { [weekNumber]: statsPayload }
let statsCacheByWeek = {};

// Modal state
let modalIsOpen = false;
let modalLastFocusedEl = null;

function setImgSrc(id, src) {
  const el = document.getElementById(id);
  if (el && el.tagName === "IMG") el.src = src;
}

// ------------------------------
// Player modal helpers
// ------------------------------
function getEl(id) {
  return document.getElementById(id);
}

function openPlayerModal() {
  const backdrop = getEl("player-modal-backdrop");
  if (!backdrop) return;

  modalLastFocusedEl = document.activeElement;
  backdrop.classList.add("open");
  backdrop.setAttribute("aria-hidden", "false");
  modalIsOpen = true;

  const closeBtn = getEl("player-modal-close");
  if (closeBtn) closeBtn.focus();
}

function closePlayerModal() {
  const backdrop = getEl("player-modal-backdrop");
  if (!backdrop) return;

  backdrop.classList.remove("open");
  backdrop.setAttribute("aria-hidden", "true");
  modalIsOpen = false;

  if (modalLastFocusedEl && typeof modalLastFocusedEl.focus === "function") {
    modalLastFocusedEl.focus();
  }
}

function wirePlayerModalEventsOnce() {
  const backdrop = getEl("player-modal-backdrop");
  const closeBtn = getEl("player-modal-close");
  if (!backdrop || !closeBtn) return;

  if (backdrop.__wired) return;
  backdrop.__wired = true;

  closeBtn.addEventListener("click", closePlayerModal);

  backdrop.addEventListener("click", (e) => {
    if (e.target === backdrop) closePlayerModal();
  });

  document.addEventListener("keydown", (e) => {
    if (!modalIsOpen) return;
    if (e.key === "Escape") closePlayerModal();
  });
}

function safeText(v) {
  return v === undefined || v === null ? "" : String(v);
}

function buildEspnPlayerUrl(playerObj) {
  const espnId = playerObj?.espn_id ?? playerObj?.espnId;
  if (!espnId) return "";
  return `https://www.espn.com/nfl/player/_/id/${encodeURIComponent(String(espnId))}`;
}

async function fetchStatsForWeekCached(season, week) {
  const w = Number(week);
  if (statsCacheByWeek[w]) return statsCacheByWeek[w];

  const url = `${API_BASE}/stats/nfl/${season}/${w}`;
  const data = await tryFetchFirst([url]);
  statsCacheByWeek[w] = data || null;
  return statsCacheByWeek[w];
}

function getPlayerStatsFromWeekPayload(weekPayload, playerId) {
  if (!weekPayload) return null;
  const pid = String(playerId);

  if (typeof weekPayload === "object" && !Array.isArray(weekPayload)) {
    if (weekPayload[pid]) return weekPayload[pid];
    if (weekPayload[String(Number(pid))]) return weekPayload[String(Number(pid))];

    const nested = weekPayload.data || weekPayload.stats || null;
    if (nested) return getPlayerStatsFromWeekPayload(nested, pid);
  }

  if (Array.isArray(weekPayload)) {
    const row = weekPayload.find((r) => String(r?.player_id ?? r?.playerId ?? r?.id) === pid);
    if (!row) return null;
    return row?.stats ? row.stats : row;
  }

  return null;
}

function formatStatValue(v) {
  if (v === undefined || v === null) return "—";
  const n = Number(v);
  if (Number.isFinite(n)) return Math.abs(n % 1) < 1e-9 ? String(n) : n.toFixed(2);
  return String(v);
}

function pickRelevantStats(position, statsObj) {
  const keysCommon = [
    ["pts_ppr", "PPR Pts"],
    ["pts_half_ppr", "Half PPR"],
    ["pts_std", "Std Pts"],
  ];

  const qb = [
    ["pass_att", "Pass Att"],
    ["pass_cmp", "Pass Cmp"],
    ["pass_yd", "Pass Yds"],
    ["pass_td", "Pass TD"],
    ["pass_int", "INT"],
    ["rush_att", "Rush Att"],
    ["rush_yd", "Rush Yds"],
    ["rush_td", "Rush TD"],
  ];

  const rbwrte = [
    ["rush_att", "Rush Att"],
    ["rush_yd", "Rush Yds"],
    ["rush_td", "Rush TD"],
    ["rec", "Rec"],
    ["rec_tgt", "Targets"],
    ["rec_yd", "Rec Yds"],
    ["rec_td", "Rec TD"],
    ["fum_lost", "Fum Lost"],
  ];

  const k = [
    ["fgm", "FG Made"],
    ["fga", "FG Att"],
    ["xpm", "XP Made"],
    ["xpa", "XP Att"],
  ];

  const def = [
    ["def_sack", "Sacks"],
    ["def_int", "INT"],
    ["def_fum_rec", "Fum Rec"],
    ["def_td", "Def TD"],
    ["def_pts_allow", "Pts Allowed"],
  ];

  const pos = String(position || "").toUpperCase();
  let list = keysCommon;
  if (pos === "QB") list = [...keysCommon, ...qb];
  else if (pos === "K") list = [...keysCommon, ...k];
  else if (pos === "DEF") list = [...keysCommon, ...def];
  else list = [...keysCommon, ...rbwrte];

  const rows = [];
  for (const [k1, label] of list) {
    if (statsObj && Object.prototype.hasOwnProperty.call(statsObj, k1)) {
      rows.push([label, formatStatValue(statsObj[k1])]);
    }
  }
  return rows.length ? rows : [["Stats", "No data"]];
}

function renderPlayerModalContent({ title, subtitle, actionsHtml, bodyHtml }) {
  const titleEl = getEl("player-modal-title");
  const subEl = getEl("player-modal-subtitle");
  const actionsEl = getEl("player-modal-actions");
  const bodyEl = getEl("player-modal-body");

  if (titleEl) titleEl.textContent = title;
  if (subEl) subEl.textContent = subtitle;
  if (actionsEl) actionsEl.innerHTML = actionsHtml;
  if (bodyEl) bodyEl.innerHTML = bodyHtml;
}

async function showPlayerDetailsModal(playerId) {
  wirePlayerModalEventsOnce();

  const player = playerCache[String(playerId)] || playerCache[Number(playerId)] || null;
  if (!player) return;

  const position = String(player?.position || "").toUpperCase();
  const team = safeText(player?.team || "");
  const name = safeText(player?.full_name || (player?.first_name ? `${player.first_name} ${player.last_name}` : "Player"));

  const espnUrl = buildEspnPlayerUrl(player);
  const actions = espnUrl
    ? `<a href="${espnUrl}" target="_blank" rel="noopener noreferrer">Open ESPN player page</a>`
    : `<span class="player-muted">ESPN link unavailable (no espn_id)</span>`;

  renderPlayerModalContent({
    title: name,
    subtitle: `${team ? team + " • " : ""}${position || ""}`.trim(),
    actionsHtml: actions,
    bodyHtml: `<div class="player-loading">Loading stats, game log, and projections…</div>`,
  });

  openPlayerModal();

  const season = Number(nflState?.season) || new Date().getFullYear();
  const currentWeek = Number(DISPLAY_WEEK);

  const weeksToFetch = [];
  for (let w = Math.max(1, currentWeek - 5); w <= Math.max(1, currentWeek - 1); w += 1) {
    weeksToFetch.push(w);
  }

  const weekPayloads = [];
  for (const w of weeksToFetch) {
    try {
      const payload = await fetchStatsForWeekCached(season, w);
      weekPayloads.push({ week: w, payload });
    } catch (_) {
      weekPayloads.push({ week: w, payload: null });
    }
  }

  const gameLogRows = [];
  const seasonAgg = {};

  for (const { week, payload } of weekPayloads) {
    const statsObj = getPlayerStatsFromWeekPayload(payload, playerId);
    if (!statsObj) {
      gameLogRows.push({ week, pts: "—", note: "No data" });
      continue;
    }

    const pts = statsObj?.pts_ppr ?? statsObj?.fantasy_points ?? statsObj?.points;
    gameLogRows.push({ week, pts: formatStatValue(pts), note: "" });

    for (const [k, v] of Object.entries(statsObj)) {
      const n = Number(v);
      if (!Number.isFinite(n)) continue;
      seasonAgg[k] = (Number(seasonAgg[k]) || 0) + n;
    }
  }

  const latestProjections = window.__latestProjections || {};
  const projObj = latestProjections?.[String(playerId)] || latestProjections?.[Number(playerId)] || null;
  const projPts = getProjectedPoints(projObj);

  const seasonRows = pickRelevantStats(position, seasonAgg);

  const gameLogTable = `
    <table class="player-table" aria-label="Game log">
      <thead>
        <tr>
          <th>Week</th>
          <th>PPR Pts</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        ${gameLogRows
          .map((r) => `<tr><td>${r.week}</td><td>${escapeHtml(r.pts)}</td><td class="player-muted">${escapeHtml(r.note || "")}</td></tr>`)
          .join("")}
      </tbody>
    </table>
  `;

  const seasonTable = `
    <div class="player-kv" aria-label="Season totals (recent weeks aggregated)">
      ${seasonRows.map(([k, v]) => `<div class="k">${escapeHtml(k)}</div><div>${escapeHtml(v)}</div>`).join("")}
    </div>
  `;

  const projPanel = `
    <div class="player-kv" aria-label="Projection">
      <div class="k">Projected (PPR)</div><div>${escapeHtml(formatStatValue(projPts))}</div>
      <div class="k">Week</div><div>${escapeHtml(String(currentWeek))}</div>
    </div>
  `;

  const body = `
    <div class="player-modal-grid">
      <div class="player-panel">
        <h3>Projection</h3>
        ${projPanel}
        <div class="player-muted" style="margin-top:8px;">Projection comes from Sleeper projections endpoint for Week ${escapeHtml(String(currentWeek))}.</div>
      </div>
      <div class="player-panel">
        <h3>Season totals</h3>
        ${seasonTable}
        <div class="player-muted" style="margin-top:8px;">Totals are aggregated from the last 5 completed weeks prior to Week ${escapeHtml(String(currentWeek))}.</div>
      </div>
      <div class="player-panel" style="grid-column: 1 / -1;">
        <h3>Recent game log</h3>
        ${gameLogTable}
      </div>
    </div>
  `;

  renderPlayerModalContent({
    title: name,
    subtitle: `${team ? team + " • " : ""}${position || ""}`.trim(),
    actionsHtml: actions,
    bodyHtml: body,
  });
}

  // Inside fetchDynamicData(week, season) function, after:
  // const projections = normalizeProjectionsToMap(projectionsRaw || {});
  // Insert:
  // window.__latestProjections = projections;

  // Inside renderStarters(...) function, replace:
  // const card = document.createElement("div");
  // card.className = "player-card";
  // With:
  // const card = document.createElement("div");
  // card.className = "player-card";
  //
  // // Make cards tappable/clickable to open modal
  // card.setAttribute("role", "button");
  // card.setAttribute("tabindex", "0");
  // card.dataset.playerId = playerId;

  // Inside renderStarters(...) function, before:
  // container.appendChild(card);
  // Insert:
  //
  // // Only show modal for real players (skip team DEF tokens like "HOU")
  // if (!isTeamDef) {
  //   const open = () => {
  //     showPlayerDetailsModal(playerId).catch((e) => console.error("Player modal error:", e));
  //   };
  //
  //   card.addEventListener("click", open);
  //   card.addEventListener("keydown", (e) => {
  //     if (e.key === "Enter" || e.key === " ") {
  //       e.preventDefault();
  //       open();
  //     }
  //   });
  // }
