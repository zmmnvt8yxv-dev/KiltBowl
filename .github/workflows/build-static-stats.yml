name: Build Static Player Stats JSON

on:
  workflow_dispatch:
  schedule:
    # Tuesdays after MNF
    - cron: "0 10 * * 2"

permissions:
  contents: write

jobs:
  build-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Fetch current NFL week and season (Sleeper)
        run: |
          set -euxo pipefail
          curl -s https://api.sleeper.app/v1/state/nfl > nfl_state.json
          echo "SEASON=$(jq -r '.season' nfl_state.json)" >> $GITHUB_ENV
          echo "WEEK=$(jq -r '.week' nfl_state.json)" >> $GITHUB_ENV

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pandas pyarrow

      - name: Build data/stats-static.json (nflverse parquet)
        run: |
          set -euxo pipefail
          mkdir -p data

          python3 - <<'PY'
          import os, json, re, datetime
          import pandas as pd

          SEASON = int(os.environ["SEASON"])
          CURRENT_WEEK = int(os.environ["WEEK"])
          LAST_COMPLETED_WEEK = max(0, CURRENT_WEEK - 1)

          PARQUET_URL = "https://github.com/nflverse/nflverse-data/releases/download/player_stats/player_stats.parquet"
          SLEEPER_URL = "https://api.sleeper.app/v1/players/nfl"

          # ---------- helpers ----------
          def norm_str(v):
            if v is None:
              return ""
            if not isinstance(v, str):
              v = str(v)
            return v.strip()

          def norm_name(v):
            v = norm_str(v).lower()
            v = re.sub(r"[^a-z\s\-\.]", "", v)
            v = re.sub(r"\s+", " ", v).strip()
            return v

          def to_int(v):
            try:
              return int(float(v))
            except Exception:
              return 0

          def to_float(v):
            try:
              return float(v)
            except Exception:
              return 0.0

          def first_val(row, *cols):
            for c in cols:
              if c in row and pd.notna(row[c]):
                return row[c]
            return None

          # ---------- load sleeper players ----------
          sleeper_df = pd.read_json(SLEEPER_URL).T

          gsis_to_sleeper = {}
          fallback = {}

          for sid, r in sleeper_df.iterrows():
            gsis = norm_str(r.get("gsis_id"))
            if gsis:
              gsis_to_sleeper[gsis] = str(sid)

            name = norm_name(
              r.get("full_name")
              or f"{r.get('first_name','')} {r.get('last_name','')}"
            )
            team = norm_str(r.get("team"))
            pos = norm_str(r.get("position")).upper()

            if name and team and pos:
              fallback[(name, team, pos)] = str(sid)

          # ---------- load nflverse parquet ----------
          df = pd.read_parquet(PARQUET_URL)

          df["season"] = pd.to_numeric(df["season"], errors="coerce")
          df["week"] = pd.to_numeric(df["week"], errors="coerce")
          df["season_type"] = df.get("season_type", "REG").astype(str).str.upper()

          df = df[
            (df["season"] == SEASON) &
            (df["season_type"] == "REG") &
            (df["week"].between(1, LAST_COMPLETED_WEEK))
          ].copy()

          # ---------- map to sleeper ids ----------
          def map_sleeper(row):
            pid = norm_str(row.get("player_id"))
            if pid and pid in gsis_to_sleeper:
              return gsis_to_sleeper[pid]

            name = norm_name(first_val(row, "player_display_name", "player_name"))
            team = norm_str(first_val(row, "recent_team", "team"))
            pos = norm_str(row.get("position")).upper()
            return fallback.get((name, team, pos))

          df["sleeper_id"] = df.apply(map_sleeper, axis=1)
          df = df[df["sleeper_id"].notna()].copy()

          # ---------- build output ----------
          weeks = {}

          for wk, g in df.groupby(df["week"].astype(int)):
            wk = str(int(wk))
            weeks[wk] = {}

            for _, r in g.iterrows():
              sid = str(r["sleeper_id"])
              weeks[wk][sid] = {
                "player_name": norm_str(first_val(r, "player_display_name", "player_name")),
                "team": norm_str(first_val(r, "recent_team", "team")),
                "pos": norm_str(r.get("position")).upper(),

                # Passing
                "pass_cmp": to_int(r.get("completions")),
                "pass_att": to_int(r.get("attempts")),
                "pass_yd": to_float(r.get("passing_yards")),
                "pass_td": to_int(r.get("passing_tds")),
                "pass_int": to_int(r.get("interceptions")),

                # Rushing
                "rush_att": to_int(r.get("carries")),
                "rush_yd": to_float(r.get("rushing_yards")),
                "rush_td": to_int(r.get("rushing_tds")),

                # Receiving
                "rec": to_int(r.get("receptions")),
                "rec_tgt": to_int(r.get("targets")),
                "rec_yd": to_float(r.get("receiving_yards")),
                "rec_td": to_int(r.get("receiving_tds")),

                # Fumbles
                "fum": to_int(r.get("fumbles")),
                "fum_lost": to_int(r.get("fumbles_lost")),

                # Fantasy
                "fantasy_points_ppr": to_float(r.get("fantasy_points_ppr")),
                "fantasy_points": to_float(r.get("fantasy_points")),
              }

          out = {
            "season": SEASON,
            "generated_at": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
            "last_completed_week": LAST_COMPLETED_WEEK,
            "source": "nflverse/nflverse-data player_stats (parquet)",
            "weeks": weeks,
          }

          with open("data/stats-static.json", "w", encoding="utf-8") as f:
            json.dump(out, f, indent=2)

          print("Wrote data/stats-static.json")
          print("Weeks:", len(weeks))
          if weeks:
            w0 = sorted(weeks.keys(), key=lambda x: int(x))[0]
            k0 = next(iter(weeks[w0]))
            print("Sample:", w0, k0, weeks[w0][k0])
          PY

      - name: Commit and push (stats-bot branch)
        run: |
          set -euxo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git checkout -B stats-bot
          git add data/stats-static.json
          git commit -m "Update static player stats (week ${WEEK})" || exit 0
          git push -u origin stats-bot --force
