name: Build Static Sleeper Stats JSON

on:
  workflow_dispatch:
  schedule:
    - cron: "0 10 * * 2"

permissions:
  contents: write

jobs:
  build-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Fetch current NFL week and season
        run: |
          set -euxo pipefail
          curl -s https://api.sleeper.app/v1/state/nfl > nfl_state.json
          cat nfl_state.json
          echo "SEASON=$(jq -r '.season' nfl_state.json)" >> $GITHUB_ENV
          echo "WEEK=$(jq -r '.week' nfl_state.json)" >> $GITHUB_ENV

      - name: Build data/stats-static.json
        run: |
          set -euxo pipefail
          mkdir -p data

          python3 - <<'PY'
          import json, os, urllib.request, datetime

          season = int(os.environ["SEASON"])
          current_week = int(os.environ["WEEK"])
          last_completed = max(0, current_week - 1)

          def fetch_json(url):
            with urllib.request.urlopen(url, timeout=60) as r:
              return json.loads(r.read().decode("utf-8"))

          weeks = {}
          for w in range(1, last_completed + 1):
            url = f"https://api.sleeper.app/v1/stats/nfl/{season}/{w}"
            try:
              data = fetch_json(url)
              weeks[str(w)] = data if data else None
              print(f"Week {w}: OK")
            except Exception as e:
              weeks[str(w)] = None
              print(f"Week {w}: FAILED ({e})")

          out = {
            "season": season,
            "generated_at": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
            "last_completed_week": last_completed,
            "weeks": weeks
          }

          with open("data/stats-static.json", "w", encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, indent=2)

          print("Wrote data/stats-static.json")
          PY

          test -f data/stats-static.json
          ls -la data
          head -n 20 data/stats-static.json

      - name: Show ignore status (common root cause)
        run: |
          set -euxo pipefail
          echo "---- .gitignore (if present) ----"
          test -f .gitignore && cat .gitignore || echo "no .gitignore"
          echo "---- git check-ignore ----"
          git check-ignore -v data/stats-static.json || echo "NOT ignored"

      - name: Commit and push to stats-bot branch
        run: |
          set -euxo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git checkout -B stats-bot

          # Force-add in case data/ is ignored
          git add -f data/stats-static.json
          git status

          git commit -m "Update static Sleeper stats (week ${WEEK})" || exit 0
          git push -u origin stats-bot --force
