name: Build Static Sleeper Stats

on:
  workflow_dispatch:
  schedule:
    - cron: "0 10 * * 2" # Tue 10:00 UTC

permissions:
  contents: write

jobs:
  build-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Fetch current NFL week and season
        run: |
          set -euxo pipefail
          curl -s https://api.sleeper.app/v1/state/nfl > nfl_state.json
          cat nfl_state.json
          echo "SEASON=$(jq -r '.season' nfl_state.json)" >> $GITHUB_ENV
          echo "WEEK=$(jq -r '.week' nfl_state.json)" >> $GITHUB_ENV

      - name: Build stats-static.yml (JSON-as-YAML, no dependencies)
        run: |
          set -euxo pipefail
          python3 - <<'PY'
          import json, os, urllib.request, datetime

          season = int(os.environ["SEASON"])
          current_week = int(os.environ["WEEK"])
          last_completed = max(0, current_week - 1)

          def fetch_json(url):
            with urllib.request.urlopen(url, timeout=60) as r:
              return json.loads(r.read().decode("utf-8"))

          weeks = {}
          for w in range(1, last_completed + 1):
            url = f"https://api.sleeper.app/v1/stats/nfl/{season}/{w}"
            try:
              data = fetch_json(url)
              weeks[str(w)] = data if data else None
              print(f"Week {w}: OK")
            except Exception as e:
              weeks[str(w)] = None
              print(f"Week {w}: FAILED ({e})")

          out = {
            "season": season,
            "generated_at": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
            "weeks": weeks
          }

          # Write JSON; valid YAML 1.2
          with open("stats-static.yml", "w", encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, indent=2)

          print("Wrote stats-static.yml")
          PY

          test -f stats-static.yml
          ls -la stats-static.yml
          head -n 25 stats-static.yml

      - name: Upload stats-static.yml artifact (proof file exists)
        uses: actions/upload-artifact@v4
        with:
          name: stats-static-yml
          path: stats-static.yml
          if-no-files-found: error

      - name: Commit and push
        run: |
          set -euxo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add stats-static.yml
          git status

          git commit -m "Update static Sleeper stats (week ${WEEK})" || exit 0
          git push
